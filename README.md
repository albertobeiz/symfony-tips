## Symfony Tips #10 - Test your Controllers

ðŸ¥³ We made it! Now all the work we have done will pay off. See how simple our tests are:

```php

    class Post_SignUpUser_Test extends TestCase
    {
        private Post_SignUpUser $useCase;
        private UserRepository $userRepository;
        private EmailService $emailService;
        private AnalyticsService $analyticsService;
    
        /**
         * @before
         */
        public function setup(): void
        {
            $this->userRepository = $this->createMock(UserRepository::class);
            $this->emailService = $this->createMock(EmailService::class);
            $this->analyticsService = $this->createMock(AnalyticsService::class);
    
            $this->useCase = new Post_SignUpUser(
                $this->userRepository,
                $this->emailService,
                $this->analyticsService
            );
        }
    
        public function testGivenUsedEmailThenThrowException()
        {
            $this->expectException(InvalidArgumentException::class);
    
            $this->userRepository->method('findOneBy')->willReturn(new User());
            $this->useCase->__invoke(new Request());
        }
    
        public function testGivenShortEmailThenThrowException()
        {
            $this->expectException(InvalidArgumentException::class);
    
            $this->useCase->__invoke(new Request(['username' => 'a']));
        }
    
        public function testGivenCorrectDataThenSaveUser()
        {
            $this->emailService->expects($this->once())->method('onUserCreated');
            $this->analyticsService->expects($this->once())->method('onUserCreated');
    
            $expectedUser = (new User())->setUsername('username')->setEmail('username@tips.com');
    
            $this->userRepository->expects($this->once())
                ->method('persist')
                ->with($this->equalTo($expectedUser));
    
            $returnedUser = $this->useCase->__invoke(new Request([
                'username' => 'username',
                'email' => 'username@tips.com'
            ]));
    
            $this->assertEquals($expectedUser, $returnedUser);
        }
    }
```


### Why?

There's plenty of literature about why you should test your app on the internet...you'll have less bugs, the ones you have you'll fix them faster, better app design...and you'll sleep better ðŸ˜…

Thanks to our previous tips we only have to mock business services (and we will remove them in future tips), we can catch exceptions and test the result as an Object.

You can start doing TDD now!

#### What about the id?

We have a problem with that, the user id is being generated by the database (after the flush) and we can't test it right now ðŸ˜± let's solve it in the next tip.

You can run **php ./vendor/bin/phpunit** to run the tests.

> Symfony tip completed! Check the [final code](https://github.com/albertobeiz/symfony-tips/tree/10)!

Next Tip -> [Symfony Tips #11 - Use Uuids as identifiers](https://github.com/albertobeiz/symfony-tips/tree/11)

Previous Tip -> [Symfony Tips #09 - Catch exceptions in an Event Subscriber](https://github.com/albertobeiz/symfony-tips/tree/09)
